name: Deployment Pipeline

on:
  push:
    branches: [ "development", "stage", "test" ]

env:
  PROJECT_TYPE: 'vue'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Execute Pipeline
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: PROJECT_TYPE
          script: |
            set -e
            BRANCH=${{ github.ref_name }}
            
            # 1. INITIALIZATION
            cd /var/www/html/$BRANCH/$PROJECT_TYPE-project
            git pull origin $BRANCH

            # 2. SONARQUBE ANALYSIS (Full Path + Single Line Fix)
            export SONAR_NODE_ARGS='--max-old-space-size=512'
            /home/ubuntu/sonar-scanner/bin/sonar-scanner -Dsonar.projectKey=${PROJECT_TYPE}-project -Dsonar.sources=. -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} -Dsonar.login=${{ secrets.SONAR_TOKEN }}

            # 3. QUALITY GATE (Exact Jenkins Logic)
            sleep 10
            for i in {1..24}; do
              STATUS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: "${{ secrets.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=${PROJECT_TYPE}-project" | jq -r '.projectStatus.status')
              if [ "$STATUS" = "OK" ] || [ "$STATUS" = "ERROR" ]; then break; fi
              sleep 5
            done

            # 4. SAFETY CHECK
            if [ "$STATUS" != "OK" ]; then exit 1; fi

            # 5. BUILD AND DEPLOY
            case "$PROJECT_TYPE" in
                vue) VITE_BASE_URL="/$PROJECT_TYPE/$BRANCH/" BASE_URL="/$PROJECT_TYPE/$BRANCH/" npm run build ;;
                nextjs) npm run build && pm2 restart $PROJECT_TYPE-$BRANCH ;;
                laravel) sudo php artisan optimize ;;
            esac
  # ========================================================================
  # SLACK NOTIFICATION (Commented Out)
  # ========================================================================
  # notify:
  #   needs: deploy
  #   if: always()
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Send Slack Notification
  #       run: |
  #         if [ "${{ needs.deploy.result }}" == "success" ]; then
  #            TEXT="‚úÖ *Deployment Successful*\nüìÇ Project: ${{ env.PROJECT_TYPE }}\nüåø Branch: ${{ github.ref_name }}\nüöÄ Status: Live"
  #         else
  #            TEXT="‚ùå *Pipeline Failed*\nüìÇ Project: ${{ env.PROJECT_TYPE }}\nüåø Branch: ${{ github.ref_name }}\nüí• Check Logs."
  #         fi
  #         curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$TEXT\"}" ${{ secrets.SLACK_WEBHOOK }}
