name: Deployment Pipeline

on:
  push:
    branches: [ "development", "stage", "test" ]

env:
  PROJECT_TYPE: 'vue' # Change this to 'laravel' or 'nextjs' as needed

jobs:
  # ========================================================================
  # STAGE 1: Build and Deploy (Directly on Server)
  # ========================================================================
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: PROJECT_TYPE
          script: |
            set -e
            BRANCH_NAME=${{ github.ref_name }}
            
            echo "--- üöÄ Deploying $PROJECT_TYPE project on branch $BRANCH_NAME ---"
            
            # Navigate to project folder
            cd /var/www/html/$BRANCH_NAME/$PROJECT_TYPE-project
            
            # Pull latest changes (Using standard git pull as requested)
            git pull origin $BRANCH_NAME
            
            # Run Build Commands based on Project Type
            case "$PROJECT_TYPE" in
                vue) 
                    # Dynamically set base path: e.g., /vue/development/
                    export BASE_URL="/$PROJECT_TYPE/$BRANCH_NAME/"
                    npm run build 
                    ;;
                nextjs) 
                    npm run build
                    pm2 restart $PROJECT_TYPE-$BRANCH_NAME 
                    ;;
                laravel) 
                    sudo php artisan optimize 
                    ;;
            esac

  # ========================================================================
  # POST ACTIONS: Slack Notifications (COMMENTED OUT FOR NOW)
  # ========================================================================
  # post-actions:
  #   needs: deploy
  #   if: always()
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Notify Success
  #       if: needs.deploy.result == 'success'
  #       run: |
  #         curl -X POST -H 'Content-type: application/json' \
  #         --data '{"text":"‚úÖ *Deployment Successful*\\nüìÇ Project: ${{ env.PROJECT_TYPE }}\\nüåø Branch: ${{ github.ref_name }}\\nüöÄ Status: Live"}' \
  #         ${{ secrets.SLACK_WEBHOOK }}
  #
  #     - name: Notify Failure
  #       if: needs.deploy.result == 'failure'
  #       run: |
  #         curl -X POST -H 'Content-type: application/json' \
  #         --data '{"text":"‚ùå *Pipeline Failed*\\nüìÇ Project: ${{ env.PROJECT_TYPE }}\\nüåø Branch: ${{ github.ref_name }}\\nüí• Failed Stage: *Build and Deploy*\\nüîç Action: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Click here to find the error in logs>"}' \
  #         ${{ secrets.SLACK_WEBHOOK }}
